name: Build iOS App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        default: 'release'
        type: choice
        options: [debug, release]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          # List available Xcode versions
          ls -d /Applications/Xcode*.app
          # Use Xcode 26.x for iOS 26 Liquid Glass support
          if [ -d "/Applications/Xcode_26.2.0.app" ]; then
            XCODE="/Applications/Xcode_26.2.0.app"
          elif [ -d "/Applications/Xcode_26.1.1.app" ]; then
            XCODE="/Applications/Xcode_26.1.1.app"
          elif [ -d "/Applications/Xcode_26.1.0.app" ]; then
            XCODE="/Applications/Xcode_26.1.0.app"
          elif [ -d "/Applications/Xcode_26.0.1.app" ]; then
            XCODE="/Applications/Xcode_26.0.1.app"
          else
            XCODE=$(ls -d /Applications/Xcode_26*.app 2>/dev/null | head -1)
          fi
          echo "Using Xcode: $XCODE"
          sudo xcode-select -s "$XCODE"
          xcodebuild -version

      - name: Generate App Icon
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install pillow
          python3 << 'EOF'
          from PIL import Image

          # Load and resize TechniLux logo to 1024x1024 for App Icon
          logo = Image.open('TechniLux/Resources/TechniLuxLogo.png')
          logo = logo.convert('RGBA')

          # Resize to 1024x1024
          icon = logo.resize((1024, 1024), Image.Resampling.LANCZOS)
          icon.save('TechniLux/Resources/Assets.xcassets/AppIcon.appiconset/AppIcon.png')
          print('Generated 1024x1024 app icon from TechniLux logo')
          EOF

      - name: Get version
        id: version
        run: |
          VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" TechniLux/Resources/Info.plist)
          BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" TechniLux/Resources/Info.plist)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build=${BUILD}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION} (${BUILD})"

      - name: Build unsigned app
        run: |
          xcodebuild \
            -project TechniLux.xcodeproj \
            -scheme TechniLux \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ENABLE_ON_DEMAND_RESOURCES=NO \
            build

      - name: Package IPA
        run: |
          mkdir -p Payload
          cp -r build/Build/Products/Release-iphoneos/TechniLux.app Payload/
          zip -r TechniLux-${{ steps.version.outputs.version }}-unsigned.ipa Payload
          rm -rf Payload

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TechniLux-${{ steps.version.outputs.version }}-unsigned
          path: TechniLux-${{ steps.version.outputs.version }}-unsigned.ipa
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: TechniLux iOS v${{ steps.version.outputs.version }}
          files: TechniLux-${{ steps.version.outputs.version }}-unsigned.ipa
          body: |
            ## TechniLux iOS v${{ steps.version.outputs.version }}

            Native iOS app for managing Technitium DNS Server.

            ### Installation (Feather)

            1. Download `TechniLux-${{ steps.version.outputs.version }}-unsigned.ipa` below
            2. Open [Feather](https://github.com/khcrysalis/Feather) on your iOS device
            3. Import the IPA and sign with your Apple ID
            4. Install and connect to your Technitium server

            ### Requirements

            - iOS 26.0+ (Liquid Glass UI)
            - iPhone or iPad
            - Apple ID (for signing via Feather)

            ### What's New

            See [CHANGELOG.md](https://github.com/elabx-org/technilux-ios/blob/main/CHANGELOG.md) for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
